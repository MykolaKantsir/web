{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ machine.name }} - Planning</title>

    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/planning.css' %}" rel="stylesheet">
</head>
<body>
    <div class="planning-container">
        <header class="planning-header">
            <a href="{% url 'planning_grid' %}" class="back-button">&larr; Back</a>
            <h1>{{ machine.name }}</h1>
            <p class="subtitle">View and override operations</p>
        </header>

        <div class="planning-form">
            <!-- Current Operation Section -->
            <section class="operation-section">
                <h2>Current Operation</h2>
                <p class="section-hint">The operation currently running on this machine</p>

                <!-- Monitor's Current Operation -->
                <div class="operation-display" data-monitor-slot="current"
                     {% if monitor_current %}data-operation-id="{{ monitor_current.pk }}"{% endif %}>
                    <label>
                        Monitor Assignment
                        <span class="source-badge monitor">From Monitor</span>
                    </label>
                    <div class="operation-info">
                        {% if monitor_current %}
                        <span class="operation-name">{{ monitor_current.name }}</span>
                        <span class="operation-details">{{ monitor_current.quantity }} pcs | {{ monitor_current.material }}</span>
                        <!-- Status Toggle for Monitor's Operation -->
                        <div class="status-toggle-container monitor-status-toggle">
                            <button type="button" class="status-btn setup-btn {% if monitor_current.is_setup %}active{% endif %}" data-status="setup">
                                Setup
                            </button>
                            <button type="button" class="status-btn progress-btn {% if not monitor_current.is_setup %}active{% endif %}" data-status="progress">
                                In Progress
                            </button>
                        </div>
                        {% else %}
                        <span class="operation-name empty">No operation from monitor</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Manual Override for Current -->
                <div class="operation-slot" data-slot="current"
                     {% if manual_current %}
                     data-operation-id="{{ manual_current.pk }}"
                     data-is-setup="{{ manual_current.is_setup|lower }}"
                     {% elif has_current_idle %}
                     data-is-idle="true"
                     {% endif %}>
                    <label>
                        Manual Override
                        {% if has_current_override %}
                        <span class="source-badge manual">Active</span>
                        {% endif %}
                    </label>
                    <div class="operation-selector">
                        <input type="text"
                               class="operation-search"
                               placeholder="Search to override..."
                               data-slot="current"
                               value="{% if manual_current %}{{ manual_current.name }}{% elif has_current_idle %}(Idle - No Operation){% endif %}">
                        <input type="hidden"
                               class="operation-id"
                               name="current"
                               value="{% if manual_current %}{{ manual_current.pk }}{% elif has_current_idle %}idle{% endif %}">
                        <button type="button" class="clear-btn" data-slot="current">&times;</button>
                        <div class="search-results" data-slot="current"></div>
                    </div>
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button type="button" class="idle-btn {% if has_current_idle %}active{% endif %}" data-slot="current">
                            Mark as Idle (No Operation)
                        </button>
                    </div>
                    <!-- Status Toggle Buttons -->
                    <div class="status-toggle-container" {% if not manual_current %}style="display: none;"{% endif %}>
                        <button type="button" class="status-btn setup-btn {% if manual_current and manual_current.is_setup %}active{% endif %}" data-status="setup">
                            Setup
                        </button>
                        <button type="button" class="status-btn progress-btn {% if manual_current and not manual_current.is_setup %}active{% endif %}" data-status="progress">
                            In Progress
                        </button>
                    </div>
                </div>
            </section>

            <!-- Next Operation Section -->
            <section class="operation-section">
                <h2>Next Operation</h2>
                <p class="section-hint">The operation queued to run next</p>

                <!-- Monitor's Next Operation (read-only display) -->
                <div class="operation-display">
                    <label>
                        Monitor Assignment
                        <span class="source-badge monitor">From Monitor</span>
                    </label>
                    <div class="operation-info">
                        {% if monitor_next %}
                        <span class="operation-name">{{ monitor_next.name }}</span>
                        <span class="operation-details">{{ monitor_next.quantity }} pcs | {{ monitor_next.material }}</span>
                        {% else %}
                        <span class="operation-name empty">No next operation from monitor</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Manual Override for Next -->
                <div class="operation-slot" data-slot="next"
                     {% if manual_next %}
                     data-operation-id="{{ manual_next.pk }}"
                     {% elif has_next_idle %}
                     data-is-idle="true"
                     {% endif %}>
                    <label>
                        Manual Override
                        {% if has_next_override %}
                        <span class="source-badge manual">Active</span>
                        {% endif %}
                    </label>
                    <div class="operation-selector">
                        <input type="text"
                               class="operation-search"
                               placeholder="Search to override..."
                               data-slot="next"
                               value="{% if manual_next %}{{ manual_next.name }}{% elif has_next_idle %}(Idle - No Operation){% endif %}">
                        <input type="hidden"
                               class="operation-id"
                               name="next"
                               value="{% if manual_next %}{{ manual_next.pk }}{% elif has_next_idle %}idle{% endif %}">
                        <button type="button" class="clear-btn" data-slot="next">&times;</button>
                        <div class="search-results" data-slot="next"></div>
                    </div>
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button type="button" class="idle-btn {% if has_next_idle %}active{% endif %}" data-slot="next">
                            Mark as Idle (No Operation)
                        </button>
                    </div>
                </div>
            </section>

            <!-- Override Info -->
            {% if assignment and assignment.manual_override_at %}
            <div class="override-info">
                <p>Last override: {{ assignment.manual_override_at|date:"M d, Y H:i" }}</p>
                {% if assignment.manual_override_by %}
                <p>by {{ assignment.manual_override_by.username }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Status Messages -->
        <div id="status-message" class="status-message hidden"></div>
    </div>

    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>
        const MACHINE_PK = {{ machine.pk }};
        const CSRF_TOKEN = '{{ csrf_token }}';
        const API_URLS = {
            availableOperations: '{% url "get_available_operations" %}',
            manualAssign: '{% url "manual_assign_operation" %}',
            machineAssignments: '{% url "get_machine_assignments" machine.pk %}',
            toggleStatus: '{% url "toggle_operation_status" %}'
        };
    </script>
    <script src="{% static 'js/planning.js' %}"></script>
</body>
</html>